@using Type = PokeApiNet.Type

@if (Pokemon is not null)
{
	<MudGrid Class="pa-4" Justify="Justify.Center">
		<MudItem xs="12" sm="8" md="6" lg="4">
			<MudPaper Class="d-flex flex-column align-center justify-center mud-width-full pa-2">
				<MudText Typo="Typo.h6">Base Stats</MudText>
				<MudChart ChartType="ChartType.Donut" LegendPosition="Position.Left" Width="70%" Height="100%"
					  InputData="@Data" InputLabels="@Labels" @bind-SelectedIndex="SelectedIndex" @onmouseout="OnMouseLeaveChart">
					<CustomGraphics>
						<text class="donut-inner-text" x="50%" y="40%" dominant-baseline="middle" text-anchor="middle" fill="var(--mud-palette-text-primary)" font-family="Helvetica" font-size="2">Total</text>
						<text class="donut-inner-text" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="var(--mud-palette-text-primary)" font-family="Helvetica" font-size="5">@Pokemon.GetBaseStatsTotal()</text>
						<MudPopover Open="@IsTooltipOpen" Class="pa-1" AnchorOrigin="Origin.CenterCenter" TransformOrigin="Origin.TopCenter">
							<MudText>@GetChartTooltip()</MudText>
						</MudPopover>
					</CustomGraphics>
				</MudChart>
			</MudPaper>
		</MudItem>
		<MudItem xs="12" sm="6" md="3" lg="3">
			<MudPaper Class="d-flex flex-column align-center justify-center pa-2">
				<MudStack Spacing="5" AlignItems="AlignItems.Center" Style="width: 100%;" Class="pa-2">
					<MudText Typo="Typo.h6" Class="mb-2">Defense</MudText>
					<MudStack Row="true" Style="width: 100%;" AlignItems="AlignItems.Center">
						<MudText Typo="Typo.body2" Class="mr-1" Style="width: 80px">Resist</MudText>
						<MudGrid>
							@foreach (string t in Globals.AllTypes)
							{
								@if (Pokemon.GetEffectivenessTo(t) < 1.0)
								{
									<MudStack Spacing="0" Class="d-flex flex-column align-center justify-center ma-1">
										<MudImage Src="@StringUtils.TypeImgFromName(t)" Alt="@t" title="@t" Height="20" />
										@if (Pokemon.GetEffectivenessTo(t) == 0.5)
										{
											<MudText Typo="Typo.caption">½x</MudText>
										}
										else if (Pokemon.GetEffectivenessTo(t) == 0.25)
										{
											<MudText Typo="Typo.caption" Style="font-weight: bold;">¼x</MudText>
										}
										else
										{
											<MudText Typo="Typo.caption" Style="font-weight: bold;">Imm</MudText>
										}
									</MudStack>
								}
							}
						</MudGrid>
					</MudStack>
					<MudDivider />
					<MudStack Row="true" Style="width: 100%;" AlignItems="AlignItems.Center">
						<MudText Typo="Typo.body2" Class="mr-1" Style="width: 80px">Weak</MudText>
						<MudGrid>
							@foreach (string t in Globals.AllTypes)
							{
								@if (Pokemon.GetEffectivenessTo(t) > 1.0)
								{
									<MudStack Spacing="0" Class="d-flex flex-column align-center justify-center ma-1">
										<MudImage Src="@StringUtils.TypeImgFromName(t)" Alt="@t" title="@t" Height="20" />
										@if (Pokemon.GetEffectivenessTo(t) == 2.0)
										{
											<MudText Typo="Typo.caption">2x</MudText>
										}
										else
										{
											<MudText Typo="Typo.caption" Style="font-weight: bold;">4x</MudText>
										}
									</MudStack>
								}
							}
						</MudGrid>
					</MudStack>
				</MudStack>
			</MudPaper>
		</MudItem>
		<MudItem xs="12" sm="6" md="3" lg="3">
			<MudPaper Class="d-flex flex-column align-center justify-center pa-2">
				<MudStack Spacing="5" AlignItems="AlignItems.Center" Style="width: 100%;" Class="pa-2">
					<MudText Typo="Typo.h6" Class="mb-2">Coverage</MudText>
					<MudStack Row="true" Style="width: 100%;" AlignItems="AlignItems.Center">
						<MudText Typo="Typo.body2" Class="mr-1" Style="width: 80px">STAB Moves</MudText>
						<MudGrid>
							@foreach (string t in Globals.AllTypes)
							{
								@if (Pokemon.IsCoveredBySTAB(t))
								{
									<MudImage Src="@StringUtils.TypeImgFromName(t)" Alt="@t" title="@t" Height="20" Class="ma-1" />
								}
							}
						</MudGrid>
					</MudStack>
				</MudStack>
			</MudPaper>
		</MudItem>
	</MudGrid>
}

@code {
	[Parameter]
	public SmartPokemon? Pokemon { get; set; }

	public double[] Data = new double[6];
	private int selectedIndex;
	public int SelectedIndex { 
		get
		{
			return selectedIndex;
		}
		set
		{
			selectedIndex = value;
			IsTooltipOpen = true;
		}
	}
	public string[] Labels = { "HP", "Attack", "Sp. Att", "Defense", "Sp. Def", "Speed"};

	public bool IsTooltipOpen = false;

	// when component is initialised
	protected override async Task OnInitializedAsync()
	{
		if (Pokemon is not null)
		{
			Data = Pokemon.GetBaseStatsArray();
		}
	}

	public string GetChartTooltip()
	{
		if (SelectedIndex >= 0 && SelectedIndex < Data.Length)
		{
			return Labels[SelectedIndex] + ": " + Data[SelectedIndex];
		}

		return "";
	}

	public void OnMouseLeaveChart()
	{
		IsTooltipOpen = false;
	}
}
