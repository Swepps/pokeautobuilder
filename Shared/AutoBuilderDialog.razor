@using pokeAutoBuilder.Source.TeamGeneration;
@using pokeAutoBuilder.Shared.Cards

<MudDialog>
    <DialogContent>
        <MudStack>
            <MudText Typo="Typo.body1">The controls below are used for setting the parameters used for generating a Pokémon team</MudText>
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudCheckBox T="bool" @bind-Checked="resistantAll" Label="Prioritise having a resistant Pokémon for all types"/>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudCheckBox T="bool" @bind-Checked="stabCoverageAll" Label="Prioritise having STAB coverage against all types" />
                </MudItem>
                <MudItem xs="6">
                    <MudSlider @bind-Value="moveSetBalanceWeighting" Min="0" Max="1" Step="0.05">Balance Pokémon move types</MudSlider>
                </MudItem>
                <MudItem xs="6">
                    <MudSlider @bind-Value="resistanceBalanceWeighting" Min="0" Max="1" Step="0.05">Balance team resistances</MudSlider>
                </MudItem>
                <MudItem xs="6">
                    <MudSlider @bind-Value="weaknessBalanceWeighting" Min="0" Max="1" Step="0.05">Balance team weaknesses</MudSlider>
                </MudItem>
                <MudItem xs="12">
                    <MudStack>
                        <MudText Typo="Typo.body2">Base Stat Weightings</MudText>
                        <MudStack Row="true" Spacing="1" Style="min-height: 150px;">
                            <MudSlider @bind-Value="baseStatHpWeighting" Min="0" Max="1" Step="0.05" Vertical="true">HP</MudSlider>
                            <MudSlider @bind-Value="baseStatAttWeighting" Min="0" Max="1" Step="0.05" Vertical="true">Attack</MudSlider>
                            <MudSlider @bind-Value="baseStatDefWeighting" Min="0" Max="1" Step="0.05" Vertical="true">Defense</MudSlider>
                            <MudSlider @bind-Value="baseStatSpAttWeighting" Min="0" Max="1" Step="0.05" Vertical="true">Sp. Attack</MudSlider>
                            <MudSlider @bind-Value="baseStatSpDefWeighting" Min="0" Max="1" Step="0.05" Vertical="true">Sp. Defense</MudSlider>
                            <MudSlider @bind-Value="baseStatSpeWeighting" Min="0" Max="1" Step="0.05" Vertical="true">Speed</MudSlider>
                        </MudStack>
                    </MudStack>
                </MudItem>
            </MudGrid>

            <MudGrid Justify="Justify.SpaceEvenly">
                @foreach (SmartPokemon? p in Team)
                {
                    @if (p is not null)
                    {
                        <MudItem xs="4" md="2">
                            <MudPaper>
                                <PokemonCard Pokemon="p" />
                            </MudPaper>
                        </MudItem>
                    }
                }
            </MudGrid>

            <MudStack Row="true">
                <MudButton OnClick="OnClickGenerate">Generate</MudButton>
                <MudButton OnClick="OnClickStop">Stop</MudButton>
            </MudStack>

            <MudText>@HighestFitness</MudText>

@*        <MudOverlay Visible="Generating" DarkBackground="true" Absolute="true">
            <MudProgressLinear Color="Color.Primary" Value="@ProgressValue" Class="my-7" />
        </MudOverlay>*@
        </MudStack>
    </DialogContent>
    <DialogActions>
@*        <MudButton OnClick="Cancel">Cancel</MudButton>*@
        <MudButton Color="Color.Primary" OnClick="Submit">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public PokemonTeam? LockedMembers { get; set; }

    private PokemonTeamGeneticAlgorithm GA = new PokemonTeamGeneticAlgorithm();
    private PokemonTeam Team = new PokemonTeam();

    private bool Generating = false;
    private int ProgressValue { get; set; } = 0;

    private double? HighestFitness = 0;

    public bool resistantAll = true;
    public bool stabCoverageAll = true;

    public double moveSetBalanceWeighting = 1.0;
    public double resistanceBalanceWeighting = 1.0;
    public double weaknessBalanceWeighting = 1.0;

    // base stats
    public double baseStatHpWeighting = 1.0;
    public double baseStatAttWeighting = 1.0;
    public double baseStatDefWeighting = 1.0;
    public double baseStatSpAttWeighting = 1.0;
    public double baseStatSpDefWeighting = 1.0;
    public double baseStatSpeWeighting = 1.0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            GA.GenerationRan += HandleGenerationRan;
            StateHasChanged();
        }
    }

    public void UpdateProgress(int stepsDone)
    {
        ProgressValue = stepsDone;
        StateHasChanged();
    }

    public void OnClickGenerate()
    {
        Generating = true;
        ProgressValue = 0;

        AutoBuilderWeightings weightings = new AutoBuilderWeightings(resistantAll, stabCoverageAll, moveSetBalanceWeighting,
        resistanceBalanceWeighting, weaknessBalanceWeighting, baseStatHpWeighting, baseStatAttWeighting,
        baseStatDefWeighting, baseStatSpAttWeighting, baseStatSpDefWeighting, baseStatSpeWeighting);

        GA.Initialize(Globals.PokemonStorage, LockedMembers is null ? new PokemonTeam() : LockedMembers, weightings);
        GA.Run();
        //Team = /*await*/ AutoBuilder.BuildTeamGenetic(Globals.PokemonStorage, weightings, new PokemonTeam());

    }

    public void OnClickStop()
    {
        GA.Stop();
        StateHasChanged();
    }

    // called after each generation is completed
    void HandleGenerationRan()
    {
        Team = GA.BestChromosome.GetTeam();
        HighestFitness = GA.BestChromosome.Fitness;

        StateHasChanged();
    }

    void Submit() => MudDialog!.Close(DialogResult.Ok(true));
    void Cancel() => MudDialog!.Cancel();
}
